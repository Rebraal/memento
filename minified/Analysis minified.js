message("Analysis started");var endLogged,logFile=file("/storage/emulated/0/memento/Analysis log.txt"),strLog="",arEntries=lib().entries(),score={},diff={num:0,date:""},MAPos=["Contentment","Tranquility","Enthusiasm","Mental clarity","Processing speed","Focus","Energy","Motivation"],MANeg=["Fatigue","Sleepiness","Torso, leaden","Arms, leaden","Legs, leaden"],CAANeg=["Fatigue","Sleepiness","Anxiety","Depression","Irritation\t","Confrontational","Paranoia","Clumsiness","Torso, leaden","Arms, leaden","Legs, leaden"],arExercises=[{n:"glutes 1",i:3},{n:"glutes 2",i:5},{n:"squat",i:30},{n:"press up",i:30}];function overviewAnalysis(){for(var e,r=0;r<arEntries.length;r++)e=arEntries[r],score={ma:0,caa:0,ovd:0},strLog+="\n\n"+e.field("Day start")+"\nscore: "+JSON.stringify(score),message(r+" of "+arEntries.length);logFile.write(strLog),logFile.close()}function updateScoreSleepCAACycle(e){var r=getEndLogged(e);if(null!=r){endLogged=parseInt(parseFloat(r.h))<10?"0"+r.h:r.h,endLogged+=":"+parseInt(parseFloat(r.m))<10?"0"+r.m:r.m;var t=getEndSC(e);if(null!=t){if(eDiff=getDiff(r,t),null==eDiff)return null;score.ma+=(3-eDiff)/3}return null}return null}function getEndLogged(e){var r,t,n=[];return e.field("Sleep - night").split("\n").map(e=>"string"!=typeof e?null:null==(t=e.match(/Sleep @ (\d+):(\d+), (\d+)(.\d+).*/))?null:(t[1]=parseInt(parseFloat(t[1]))+parseInt(parseFloat(t[3])),t[1]>24&&(t[1]-=24),t[2]=Math.round(parseFloat(t[2])+60*parseFloat(t[4])),t[2]>60&&(t[2]-=60,t[1]+=1),r={h:t[1],m:t[2]},void n.push(r))),n.length>0?(r={h:0,m:0},n.map(e=>{e.h<12&&e.h>r.h&&(r=e)}),r):null}function getEndSC(e){var r=e.field("Sleep Cycle data");return null!=(r=r.match(/.* to (\d+):(\d+)/))?{h:parseInt(parseFloat(r[1])),m:parseInt(parseFloat(r[2]))}:null}function getDiff(e,r){e.m-=r.m,e.m<0&&(e.m+=60,e.h-=1);var t=parseFloat((e.h-r.h+e.m/60).toFixed(2));return t>=0?t:null}function getSymValMA(e,r){for(var t=e.field("Symptoms - current").split("\n"),n=0;n<t.length;n++){var a=t[n].match(new RegExp(".*"+r+".*?(\\[.*\\])"));if(null!=a){if(1==(a=JSON.parse(a[1])).length){var l=parseInt(parseFloat(a[0][1]));return l}for(var s=null,i=0;i<a.length;i++){if(a[i]>endLogged||a[i]<"04:00")return l=null==s?parseInt(parseFloat(a[i][1])):parseInt(parseFloat(s));s=a[i][1]}}}return 0}function updateOverviewMA(e){for(var r=e.field("Average overview breakdown").split("\n"),t=0;t<r.length;t++)if(r[t]>endLogged){var n=r[t].match(/\d+:\d+ - (\d+)/)[1];return score.ma+=n/8,n}return null}function updateScoreMA(e){MAPos.map(r=>{score.ma+=getSymValMA(e,r)/5}),MANeg.map(r=>{score.ma+=(5-getSymValMA(e,r))/5})}function updateScoreFirstIntake(e){for(var r,t,n=e.field("Intake - combined").split("\n\n"),a="",l=0;l<n.length;l++)if((r=n[l].split("\n")).length>4){a=r[0].trim();break}t=(a=""==a?"08:45":a)>"11:00"?0:a>"10:00"?.4:a>"08:45"?.75:a>"06:30"?1:0,score.ma+=t}function updateScoreExerciseMA(e){for(var r,t,n=e.field("Exercise breakdown").split("\n\n"),a=0;a<n.length;a++)if(exLines=n[a].split("\n"),null!=(r=exLines[0].match(/(\d+:\d+).*/))&&r[1]<"10:00")for(var l=0;l<arExercises.length;l++)null!=(t=n[a].match(new RegExp("^(\\d+)\\s+"+arExercises[l].n)))&&(score.ma+=t[1]/arExercises[l].i)}function timeStringToObject(e){return null!=(e=e.match(/(\d+):(\d+)/))?{h:parseFloat(e[1]),m:parseFloat(e[2])}:null}function getSpan(e,r){strLog+="\ngetSpan: t0: "+e+", t1: "+r,e=timeStringToObject(e),r=timeStringToObject(r),strLog+="\ngetSpan: t0: "+JSON.stringify(e)+"\nt1: "+JSON.stringify(r);var t={h:0,m:r.m-e.m};return t.m<0&&(t.m+=60,t.h-=1),t.h+=r.h-e.h,t.h<0&&(t.h+=24),strLog+="\ngetSpan 1: r: "+JSON.stringify(t),t=parseFloat((t.h+t.m/60).toFixed(2)),strLog+="\ngetSpan 2: r "+t,t}function getSymValCAA(e,r){for(var t=e.field("Symptoms - current").split("\n"),n=0;n<t.length;n++){var a=t[n].match(new RegExp(".*"+r+".*?(\\[.*\\])"));if(null!=a){if(1==(a=JSON.parse(a[1])).length)return parseInt(parseFloat(a[0][1]));for(var l="04:00",s=0,i=0;i<a.length;i++)s+=getSpan(l,a[i][0])*parseInt(parseFloat(a[i][1])),l=a[i][0];return(s+=getSpan(l,"03:59")*parseInt(parseFloat(a[a.length-1][1])))/24}}return 0}function updateScoreCAA(e,r,t){r.map(r=>{score.caa+=getSymValCAA(e,r)/5}),t.map(r=>{score.caa+=(5-getSymValCAA(e,r))/5})}function updateScoreSleepCAA(e){var r=e.field("Sleep - total day");r>6&&(r=6),score.caa+=(6-r)/6}function updateScoreExerciseCAA(e){for(var r,t=e.field("Exercise breakdown").split("\n\n"),n=0;n<t.length;n++)if(exLines=t[n].split("\n"),null!=exLines[0].match(/(\d+:\d+).*/))for(var a=0;a<arExercises.length;a++)null!=(r=t[n].match(new RegExp("^(\\d+)\\s+"+arExercises[a].n)))&&(score.caa+=r[1]/arExercises[a].i)}function updateOverviewDuration(e){var r=e.field("Average overview breakdown").split("\n");if(strLog+="\nupdateOverviewDuration: ov:\n"+JSON.stringify(r),r.length>0){var t,n,a=new RegExp("(\\d+:\\d+) - (\\d+)");if(1==r.length)t=parseFloat((parseFloat(r[0].match(a)[2])/8).toFixed(2)),isNaN(t)?strLog+="\nupdateOverviewDuration: non-numeric overview":(strLog+="\nupdateOverviewDuration: r: "+t,score.ovd=t);else{for(var l="04:00",s=0,i=0;i<r.length;i++)strLog+="\nupdateOverviewDuration: ov[c1]: "+r[i],n=r[i].match(a),strLog+="\nupdateOverviewDuration: l: "+n,s+=getSpan(l,n[1])*parseFloat(n[2]),l=n[1];s+=getSpan(l,"03:59")*parseInt(parseFloat(r[r.length-1].match(a)[2])),strLog+="\nupdateOverviewDuration:\nr: "+(t=s/24),score.ovd=t}}}function getSymChange(e,r){for(var t=e.field("Symptoms - current").split("\n"),n=0;n<t.length;n++){var a=t[n].match(new RegExp(".*"+r+".*?(\\[.*\\])"));if(null!=a){if(1==(a=JSON.parse(a[1])).length){return 0}for(var l,s=0,i=1;i<a.length;i++)(l=parseFloat(a[cl][1])>parseFloat(a[cl-1][1]))>0?s++:l<0&&s--;return s}}return 0}try{overviewAnalysis()}catch(r){var e=new Error("Rethrowing the "+r.message+" error");throw strLog+="\n\n"+JSON.stringify(r),logFile.write(strLog),logFile.close(),e}message("Analysis updated 2020-09-08 14:21");
