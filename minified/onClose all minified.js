//DATE
function DATE_correctHour(t){return(t+=1)>23?0:t}function DATE_dd(t){return t<10?"0"+t:""+t}function DATE_stepBackDate(t,e,i){return--i<1&&(--e<1?(t--,e=12,i=31):i=DATE_daysInMonth(t,e)),t+"-"+DATE_dd(e)+"-"+DATE_dd(i)+" 04:00"}function DATE_dateSubtract(t,e){for(;e>0;)e>=t.day?(e-=t.day,t.month--,t.month<1&&(t.month=12,t.year--),t.day=DATE_daysInMonth(t.year,t.month)):(t.day-=e,e=0);return t.updateProperties(),t}function DATE_isLeapYear(t){return t%100==0?t%400==0:t%4==0}function DATE_daysInMonth(t,e){switch(e){case 11:case 9:case 6:case 4:return 30;case 2:return DATE_isLeapYear(t)?29:28;default:return 31}}function DATE(t){if("string"==typeof t){var e=t.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2})/);if(null==e&&(e=t.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/)),null==e)throw log("DATE error. "+JSON.stringify(t)+" is not a valid date string."),"DATE error. Input is not a valid date string.";this.year=parseFloat(e[1]),this.month=parseFloat(e[2]),this.day=parseFloat(e[3]),this.hour=parseFloat(e[4]),this.minute=parseFloat(e[5])}else if("function"==typeof t.field)this.year=t.field("Date").getFullYear(),this.month=t.field("Date").getMonth()+1,this.day=t.field("Date").getDate(),this.hour=DATE_correctHour(t.field("Time").getHours()),this.minute=t.field("Time").getMinutes();else{if("function"!=typeof t.getFullYear)throw log("DATE error. "+JSON.stringify(t)+" is not a valid input."),"DATE error. Input is not valid.";this.year=t.getFullYear(),this.month=t.getMonth()+1,this.day=t.getDate(),this.hour=DATE_correctHour(t.getHours()),this.minute=t.getMinutes()}this.updateProperties=function(){this.dateStamp=this.year+"-"+DATE_dd(this.month)+"-"+DATE_dd(this.day)+" "+DATE_dd(this.hour)+":"+DATE_dd(this.minute),this.hour<4?this.dayStart=DATE_stepBackDate(this.year,this.month,this.day):this.dayStart=this.year+"-"+DATE_dd(this.month)+"-"+DATE_dd(this.day)+" 04:00",this.date=this.year+"-"+DATE_dd(this.month)+"-"+DATE_dd(this.day)+" ",this.time=DATE_dd(this.hour)+":"+DATE_dd(this.minute)},this.updateProperties()}log("DATE updated 2020-08-03 20:15");
//Create symptoms graph
var sourceEntries,workingEntries,entryDate,fileDate=new DATE(new Date).dateStamp,backup=file("/storage/emulated/0/memento/Symptoms graph/Backup/Backup "+fileDate+".txt"),dstLog=file("/storage/emulated/0/memento/Symptoms graph/dstLog.txt"),graphLibrary=libByName("Symptoms graphing"),symptomEntries=[],arDataToGraph=[],strBackup="",graphChar="+";function createAllSymptomGraphs(t,e){return log("createAllSymptomGraphs called"),entryDate=t,readSymptoms(e),createGraphEntries(),backup.close(),log("graph entries created"),"Graph entries created"}function readSymptoms(t){log("readSymptoms:\n"+JSON.stringify(t)),(sourceEntries=libByName(t[0].library).entries()).map((t,e)=>{symptomEntries.push({i:e,date:t.field("Date stamp")})}),symptomEntries=symptomEntries.sort((t,e)=>t.date>e.date?-1:1),t.map(t=>{graph=createSymptomGraph(t.symptom,t.edit),log("readSymptoms: obj.symptom: "+t.symptom),arDataToGraph.push({Library:t.library,Date:fileDate,Symptom:t.symptom,Graph:graph.graph,Log:graph.log})})}function createGraphEntries(){arDataToGraph.map(t=>{graphLibrary.create(t),strBackup+="*"+t.Symptom+"\n\n"+t.Log+"\n\n"}),backup.write(strBackup)}function createSymptomGraph(t,e){var a,r,p,m,n="",s="";log("\ncreateSymptomGraph: edit: "+e);var o=t.replace(/\*/g,"\\*"),i=new RegExp("("+o+")( i([0-5]))?(.*)?");s+=i+"\n",p=e.match(/£\s*(?=(\d*))/)[1],log("\ncreateSymptomGraph: stepBack: "+p+'stepBack == ""'+(""==p)),""==p?(log("\ncreateSymptomGraph: no valid stepBack, defaulting"),m=DATE_dateSubtract(new DATE(entryDate),2).dateStamp):(log("\ncreateSymptomGraph: valid stepBack"),m=DATE_dateSubtract(new DATE(entryDate),p).dateStamp),workingEntries=symptomEntries.filter(t=>{if(t.date>m)return t}),log("\ncreateSymptomGraph: stepBack: "+JSON.stringify(p)+"\nstartDate: "+m+"workingEntries:\n"+JSON.stringify(workingEntries));for(var l=0;l<workingEntries.length;++l)null==(a=(r=sourceEntries[workingEntries[l].i]).field("Symptoms - current").match(i))?(n+=r.field("Date stamp")+"\n",s+=r.field("Date stamp")+"\n"):null!=a[4]&&""!=a[4].trim()?(n+=r.field("Date stamp")+" ERROR\n",s+=r.field("Date stamp")+a[0]+" ERROR\n"):(n+=r.field("Date stamp")+" "+graphChar.repeat(parseInt(a[3]))+"\n",s+=r.field("Date stamp")+" "+a[2].trim()+"\n");return{graph:n,log:s}}log("Create symptoms graphs.js 2020-08-05 19:31");
//Status B,D on close
var entRef=libByName("References").entries()[0],fileSymptoms=file("/storage/emulated/0/memento/Symptoms graph/Symptoms fields.txt");fileSymptoms.write(lib().title+"\n");var arAllIntakes=["Intake - liquid","Intake - vegetables","Intake - meat and fish","Intake - fruit","Intake - nuts","Intake - misc"],strRet="",msg="",symptomsGraph=[],symptomsErrors="";function onClose(){if(message("onClose"),entry().set("Date stamp",new DATE(entry()).dateStamp),intakes(arAllIntakes),symptoms(),supplements(),""!=symptomsErrors)throw log("symptomsErrors:\n"+symptomsErrors),new Error(symptomsErrors);message("onClose end\nDeveloping:\n2020-08-05 14:15")}function intakes(){for(var e,t,n,r,s,a=0;a<arAllIntakes.length;++a){if(e=arAllIntakes[a],t=entry().field(e).trim(),entRef.field(e),""==t)return void entry().set(e,"");n=intakeRead(t),r=intakeRead(entRef.field(e)),s=intakeUpdateWhitespace(intakeSort(intakeUnique(n.concat(r)))),entry().set(e,intakeOutput(s,!0)),entRef.set(e,intakeOutput(s,!1)),strRet+=e+"\n"}}function intakeRead(e){for(var t=e.split("\n"),n=[],r=0;r<t.length;++r)""!=t[r].trim()&&n.push(parseIntake(t[r]));return n}function parseIntake(e){var t,n,r,s,a,i={ind:"",alg:"",ws:"",sub:"",qty:"",len:0};return t=e.indexOf("#")+1,i.ind=t>0?e.substring(0,t)+" ":"99# ",(n=e.indexOf("*"))>=0&&(r=e.indexOf("*",n+1)+1,i.alg=e.substring(n,r)+" "),r>=0?e=e.substring(r):t>0&&(e=e.substring(t)),s=e.search(/\S/),i.ws=e.substring(0,s),a=e.indexOf(":")+1,i.sub=e.substring(s,a)+" ",""!=(e=e.substring(a).trim())&&(i.qty=e),i.len=i.ind.length+i.alg.length+i.sub.length,i}function intakeUnique(e){for(var t=e.concat(),n=0;n<t.length;++n)for(var r=n+1;r<t.length;++r)t[n].sub==t[r].sub&&t.splice(r--,1);return t}function intakeSort(e){return e.sort(function(e,t){if(e.ind<t.ind)return-1;if(e.ind>t.ind)return 1;if(e.sub<t.sub)return-1;if(e.sub>t.sub)return 1;return 0})}function intakeUpdateWhitespace(e){for(var t=0,n=e,r=0;r<n.length;++r){var s=n[r].len;s>t&&(t=s)}for(r=0;r<n.length;++r)n[r].ws=" ".repeat(t-n[r].len);return n}function intakeOutput(e,t){var n="";if(t)for(var r=0;r<e.length;++r)""!=e[r].qty&&(n+=e[r].ind+e[r].alg+e[r].ws+e[r].sub+e[r].qty+"\n");else for(r=0;r<e.length;++r)n+=e[r].ind+e[r].alg+e[r].ws+e[r].sub+"\n";return n}function symptoms(){for(var e,t="Symptoms - current",n="Symptoms - inactive",r=entry().field(t),s=entry().field(n),a=r.split("\n"),i=s.split("\n"),u=[],o=[],l=1,p=2,f=3,m=4,d=0;d<a.length;++d){null!=(e=(g=a[d].trim()).match(/(.*)(\si[0-9])(\s*x)?\s*(£.*)?/))?(null!=e[m]&&(fileSymptoms.write(e[l]+"\n"),symptomsGraph.push({library:lib().title,symptom:e[l],edit:e[m]})),null!=e[f]?o.push(e[l]):u.push(e[l]+e[p])):(u.push(g),symptomsErrors+="Error: "+g+"\n")}for(d=0;d<i.length;++d){var g;(g=i[d]).search(/\si[0-9]/)>-1?u.push(g):o.push(g)}u=arrayAdjustNewLine(arrayUnique(arrayAdjustSortCode(u)).sort()),o=arrayAdjustNewLine(arrayUnique(arrayAdjustSortCode(o)).sort()),entry().set(t,u.join("")),entry().set(n,o.join("")),symptomsGraph.length>0&&csg(symptomsGraph)}function arrayAdjustSortCode(e){for(var t=e.concat(),n=0;n<t.length;++n){var r=t[n],s=r.search(/[0-9][0-9]/);s>0&&(r=r.substring(s))}return t}function arrayUnique(e){for(var t=e.concat(),n=0;n<t.length;++n)for(var r=n+1;r<t.length;++r)t[n]===t[r]&&t.splice(r--,1);return t}function arrayAdjustNewLine(e){var t=e.concat();for(i=0;i<t.length-1;++i)t[i]=t[i]+"\n";return t}function arrayAdjustILevel(e){for(var t=e.concat(),n=0;n<t.length;++n){var r=t[n],s=r.search(/\si[0-9]/);s>0&&(t[n]=r.substring(0,s))}return t}function supplements(){for(var e=entry().field("Supplements - taken").split("\n"),t=0;t<e.length;++t)e[t]=parseSupps(e[t]);e=arraySupplementsUpdateWhitespace(e=arrayObjectsUnique(e,["brand","supp","dose"])),entry().set("Supplements - taken",arraySupplementsOutput(e,!0))}function parseSupps(e){var t,n,r,s,a={brand:"",ws1:"",supp:"",ws2:"",dose:"",qty:0,lenBrand:0,lenSupp:0,lenDose:0};return(s=e.indexOf("#"))>=0?a.brand=e.substring(0,s+1):(t=e.indexOf("*"),a.brand=e.substring(0,t).trim()+" ",a.lenBrand=a.brand.length,n=e.indexOf("*",t+1)+1,a.supp=e.substring(t,n)+" ",a.lenSupp=a.supp.length,r=e.indexOf(":")+1,a.dose=e.substring(n,r).trim()+" ",a.lenDose=a.dose.length,a.qty=e.substring(r).trim()),a}function arrayObjectsUnique(e,t){for(var n=e.concat(),r=!0,s=0,a=0;a<n.length;++a)for(var i=a+1;i<n.length;++i){for(s=0,r=!0,n[a],n[i];s<t.length&&1==r;)n[a][t[s]]!=n[i][t[s]]&&(r=!1),++s;1==r&&n.splice(i--,1)}return n}function arraySupplementsUpdateWhitespace(e){for(var t,n,r=e,s=0,a=0,i=0;i<r.length;++i)r[i].brand.indexOf("#")<0&&((t=r[i].lenBrand+r[i].lenSupp)>s&&(s=t),(n=r[i].lenDose)>a&&(a=n));for(i=0;i<r.length;++i)r[i].ws1=" ".repeat(s-r[i].lenBrand-r[i].lenSupp),r[i].ws2=" ".repeat(a-r[i].lenDose);return r}function arraySupplementsOutput(e,t){var n="";if(t)for(var r=0;r<e.length;++r)""!=e[r].qty&&(n+=e[r].brand+e[r].ws1+e[r].supp+e[r].ws2+e[r].dose+e[r].qty+"\n");else for(r=0;r<e.length;++r)n+=e[r].brand+e[r].ws1+e[r].supp+e[r].ws2+e[r].dose+"\n";return n}function csg(e){log(entry().field("Date stamp")+"\n"+JSON.stringify(e)),createAllSymptomGraphs(entry().field("Date stamp"),e)}log("Status - B, D On close.js 2020-08-05 19:45");
