var entRef=libByName("References").entries()[0],fileSymptoms=file("/storage/emulated/0/memento/Symptoms graph/Symptoms fields.txt");fileSymptoms.write(lib().title+"\n");var arAllIntakes=["Intake - liquid","Intake - vegetables","Intake - meat and fish","Intake - fruit","Intake - nuts","Intake - misc"],strRet="";function onClose(){message("onClose\nWorking:\n2020-05-11 09:00"),entry().set("Date stamp",new DATE(entry()).dateStamp),intakes(arAllIntakes),symptoms(),supplements()}function intakes(){for(var e,n,t,r,s,a=0;a<arAllIntakes.length;++a){if(e=arAllIntakes[a],n=entry().field(e).trim(),entRef.field(e),""==n)return void entry().set(e,"");t=intakeRead(n),r=intakeRead(entRef.field(e)),s=intakeUpdateWhitespace(intakeSort(intakeUnique(t.concat(r)))),entry().set(e,intakeOutput(s,!0)),entRef.set(e,intakeOutput(s,!1)),strRet+=e+"\n"}}function intakeRead(e){for(var n=e.split("\n"),t=[],r=0;r<n.length;++r)""!=n[r].trim()&&t.push(parseIntake(n[r]));return t}function parseIntake(e){var n,t,r,s,a,i={ind:"",alg:"",ws:"",sub:"",qty:"",len:0};return n=e.indexOf("#")+1,i.ind=n>0?e.substring(0,n)+" ":"99# ",(t=e.indexOf("*"))>=0&&(r=e.indexOf("*",t+1)+1,i.alg=e.substring(t,r)+" "),r>=0?e=e.substring(r):n>0&&(e=e.substring(n)),s=e.search(/\S/),i.ws=e.substring(0,s),a=e.indexOf(":")+1,i.sub=e.substring(s,a)+" ",""!=(e=e.substring(a).trim())&&(i.qty=e),i.len=i.ind.length+i.alg.length+i.sub.length,i}function intakeUnique(e){for(var n=e.concat(),t=0;t<n.length;++t)for(var r=t+1;r<n.length;++r)n[t].sub==n[r].sub&&n.splice(r--,1);return n}function intakeSort(e){return e.sort(function(e,n){if(e.ind<n.ind)return-1;if(e.ind>n.ind)return 1;if(e.sub<n.sub)return-1;if(e.sub>n.sub)return 1;return 0})}function intakeUpdateWhitespace(e){for(var n=0,t=e,r=0;r<t.length;++r){var s=t[r].len;s>n&&(n=s)}for(r=0;r<t.length;++r)t[r].ws=" ".repeat(n-t[r].len);return t}function intakeOutput(e,n){var t="";if(n)for(var r=0;r<e.length;++r)""!=e[r].qty&&(t+=e[r].ind+e[r].alg+e[r].ws+e[r].sub+e[r].qty+"\n");else for(r=0;r<e.length;++r)t+=e[r].ind+e[r].alg+e[r].ws+e[r].sub+"\n";return t}function symptoms(){for(var e,n="Symptoms - current",t="Symptoms - inactive",r=entry().field(n),s=entry().field(t),a=r.split("\n"),i=s.split("\n"),u=[],l=[],o=1,p=2,f=3,d=4,g=0;g<a.length;++g){null!=(e=(c=a[g].trim()).match(/(.*)(\si[0-9])(\s*x)?(\s*Â£)?/))[d]&&fileSymptoms.write(e[o]+"\n"),null!=e[f]?l.push(e[o]):u.push(e[o]+e[p])}for(g=0;g<i.length;++g){var c;(c=i[g]).search(/\si[0-9]/)>-1?u.push(c):l.push(c)}u=arrayAdjustNewLine(arrayUnique(arrayAdjustSortCode(u)).sort()),l=arrayAdjustNewLine(arrayUnique(arrayAdjustSortCode(l)).sort()),entry().set(n,u.join("")),entry().set(t,l.join(""))}function arrayAdjustSortCode(e){for(var n=e.concat(),t=0;t<n.length;++t){var r=n[t],s=r.search(/[0-9][0-9]/);s>0&&(r=r.substring(s))}return n}function arrayUnique(e){for(var n=e.concat(),t=0;t<n.length;++t)for(var r=t+1;r<n.length;++r)n[t]===n[r]&&n.splice(r--,1);return n}function arrayAdjustNewLine(e){var n=e.concat();for(i=0;i<n.length-1;++i)n[i]=n[i]+"\n";return n}function arrayAdjustILevel(e){for(var n=e.concat(),t=0;t<n.length;++t){var r=n[t],s=r.search(/\si[0-9]/);s>0&&(n[t]=r.substring(0,s))}return n}function supplements(){for(var e=entry().field("Supplements - taken").split("\n"),n=0;n<e.length;++n)e[n]=parseSupps(e[n]);e=arraySupplementsUpdateWhitespace(e=arrayObjectsUnique(e,["brand","supp","dose"])),entry().set("Supplements - taken",arraySupplementsOutput(e,!0))}function parseSupps(e){var n,t,r,s,a={brand:"",ws1:"",supp:"",ws2:"",dose:"",qty:0,lenBrand:0,lenSupp:0,lenDose:0};return(s=e.indexOf("#"))>=0?a.brand=e.substring(0,s+1):(n=e.indexOf("*"),a.brand=e.substring(0,n).trim()+" ",a.lenBrand=a.brand.length,t=e.indexOf("*",n+1)+1,a.supp=e.substring(n,t)+" ",a.lenSupp=a.supp.length,r=e.indexOf(":")+1,a.dose=e.substring(t,r).trim()+" ",a.lenDose=a.dose.length,a.qty=e.substring(r).trim()),a}function arrayObjectsUnique(e,n){for(var t=e.concat(),r=!0,s=0,a=0;a<t.length;++a)for(var i=a+1;i<t.length;++i){for(s=0,r=!0,t[a],t[i];s<n.length&&1==r;)t[a][n[s]]!=t[i][n[s]]&&(r=!1),++s;1==r&&t.splice(i--,1)}return t}function arraySupplementsUpdateWhitespace(e){for(var n,t,r=e,s=0,a=0,i=0;i<r.length;++i)r[i].brand.indexOf("#")<0&&((n=r[i].lenBrand+r[i].lenSupp)>s&&(s=n),(t=r[i].lenDose)>a&&(a=t));for(i=0;i<r.length;++i)r[i].ws1=" ".repeat(s-r[i].lenBrand-r[i].lenSupp),r[i].ws2=" ".repeat(a-r[i].lenDose);return r}function arraySupplementsOutput(e,n){var t="";if(n)for(var r=0;r<e.length;++r)""!=e[r].qty&&(t+=e[r].brand+e[r].ws1+e[r].supp+e[r].ws2+e[r].dose+e[r].qty+"\n");else for(r=0;r<e.length;++r)t+=e[r].brand+e[r].ws1+e[r].supp+e[r].ws2+e[r].dose+"\n";return t}
